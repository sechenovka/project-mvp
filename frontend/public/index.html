<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messenger MVP (WebSocket)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 20px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input, button { padding: 10px; font-size: 14px; }
      input { min-width: 260px; }
      #messages { margin-top: 16px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; max-width: 900px; height: 400px; overflow-y: auto; }
      .msg { padding: 10px 0; border-bottom: 1px solid #eee; }
      .msg:last-child { border-bottom: none; }
      .meta { color: #666; font-size: 12px; margin-bottom: 4px; }
      .text { font-size: 14px; }
      .error { color: #b00020; margin-top: 10px; }
      .ok { color: #0a7a0a; margin-top: 10px; }
      .spacer { height: 8px; }
    </style>
  </head>
  <body>
    <h1>Messenger MVP (WebSocket)</h1>

    <div class="row">
      <label>
        senderId:
        <input id="senderId" placeholder="вставь user id (из seed/Prisma Studio)" />
      </label>
      <button id="saveSender">Сохранить</button>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <input id="text" placeholder="Напиши сообщение..." />
      <button id="send">Отправить</button>
      <button id="reload">Обновить историю</button>
    </div>

    <div id="status"></div>

    <div id="messages"></div>

    <!-- Подключаем Socket.IO клиент -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);

      const statusEl = $("status");
      const messagesEl = $("messages");
      const senderIdEl = $("senderId");
      const textEl = $("text");

      // Инициализация Socket.IO
      const socket = io();

      function setStatus(type, msg) {
        statusEl.className = type;
        statusEl.textContent = msg || "";
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Функция для добавления одного сообщения в DOM
      function displayMessage(message) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';

        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';

        const name = message.sender?.name || message.sender?.email || message.senderId || 'Неизвестно';
        const when = message.createdAt ? new Date(message.createdAt).toLocaleString() : '';

        metaDiv.textContent = `${escapeHtml(name)} • ${escapeHtml(when)}`;

        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = message.text;

        msgDiv.appendChild(metaDiv);
        msgDiv.appendChild(textDiv);
        messagesEl.appendChild(msgDiv);
      }

      // Загрузка истории сообщений (полная перерисовка)
      async function loadMessages() {
        try {
          setStatus("", "");
          const res = await fetch("/messages?take=200");
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || "Failed to load messages");

          // Очищаем и рендерим все сообщения
          messagesEl.innerHTML = '';
          data.forEach(displayMessage);

          // автоскролл вниз
          messagesEl.scrollTop = messagesEl.scrollHeight;
        } catch (e) {
          setStatus("error", e.message);
        }
      }

      // Отправка нового сообщения
      async function sendMessage() {
        try {
          const senderId = senderIdEl.value.trim();
          const text = textEl.value.trim();

          if (!senderId) return setStatus("error", "Укажи senderId");
          if (!text) return setStatus("error", "Напиши текст сообщения");

          setStatus("", "");

          const res = await fetch("/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, senderId }),
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || "Failed to create message");

          textEl.value = ""; // очищаем поле ввода
          setStatus("ok", "Сообщение отправлено ✅");
          // Не вызываем loadMessages – новое сообщение придёт через сокет
        } catch (e) {
          setStatus("error", e.message);
        }
      }

      // Обработчик нового сообщения от сокета
      socket.on('new_message', (message) => {
        displayMessage(message);
        messagesEl.scrollTop = messagesEl.scrollHeight; // прокрутка вниз
        setStatus("ok", "Новое сообщение получено");
      });

      // Сохранение senderId в localStorage
      senderIdEl.value = localStorage.getItem("senderId") || "";
      $("saveSender").addEventListener("click", () => {
        localStorage.setItem("senderId", senderIdEl.value.trim());
        setStatus("ok", "senderId сохранён ✅");
      });

      $("send").addEventListener("click", sendMessage);
      $("reload").addEventListener("click", loadMessages);

      textEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Загружаем историю при старте
      loadMessages();

      // Можно добавить обработчик ошибок сокета
      socket.on('connect_error', (err) => {
        setStatus('error', 'Ошибка подключения к WebSocket: ' + err.message);
      });
    </script>
  </body>
</html>