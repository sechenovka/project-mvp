<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Messenger MVP (WebSocket + SQLite)</title>
    <style>
        body { font-family: system-ui; margin: 20px; }
        .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        input, button { padding: 10px; font-size: 14px; }
        #messages { margin-top: 16px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; max-width: 900px; height: 400px; overflow-y: auto; }
        .msg { padding: 10px 0; border-bottom: 1px solid #eee; }
        .meta { color: #666; font-size: 12px; }
        .error { color: #b00020; }
        .ok { color: #0a7a0a; }
    </style>
</head>
<body>
    <h1>Messenger —Å WebSocket –∏ SQLite</h1>

    <div id="userSection" class="row">
        <input id="email" type="email" placeholder="Email (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
        <input id="name" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
        <button id="createUser">–°–æ–∑–¥–∞—Ç—å / –í–æ–π—Ç–∏</button>
    </div>

    <div class="spacer"></div>

    <div class="row">
        <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="reload">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>

    <div id="status"></div>
    <div id="messages"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ç–æ–º—É –∂–µ —Ö–æ—Å—Ç—É, –æ—Ç–∫—É–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        const socket = io(window.location.origin);

        // –õ–æ–≥–∏ —Å–æ–∫–µ—Ç–∞
        socket.on('connect', () => console.log('‚úÖ Socket connected, id:', socket.id));
        socket.on('disconnect', () => console.log('‚ùå Socket disconnected'));
        socket.on('connect_error', (err) => console.error('‚ö†Ô∏è Socket connection error:', err));

        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const emailInput = document.getElementById('email');
        const nameInput = document.getElementById('name');
        const textInput = document.getElementById('text');
        const createUserBtn = document.getElementById('createUser');
        const sendBtn = document.getElementById('send');
        const reloadBtn = document.getElementById('reload');

        let currentUserId = localStorage.getItem('userId') || null;

        function setStatus(type, msg) {
            statusEl.className = type;
            statusEl.textContent = msg;
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"]/g, function(match) {
                if (match === '&') return '&amp;';
                if (match === '<') return '&lt;';
                if (match === '>') return '&gt;';
                if (match === '"') return '&quot;';
                return match;
            });
        }

        function displayMessage(msg) {
            console.log('üì© displayMessage called with:', msg);
            try {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg';
                const meta = document.createElement('div');
                meta.className = 'meta';
                const sender = msg.sender?.name || msg.sender?.email || msg.senderId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const time = msg.createdAt ? new Date(msg.createdAt).toLocaleString() : '';
                meta.textContent = `${escapeHtml(sender)} ‚Ä¢ ${time}`;
                const textDiv = document.createElement('div');
                textDiv.textContent = msg.text;
                msgDiv.appendChild(meta);
                msgDiv.appendChild(textDiv);
                messagesEl.appendChild(msgDiv);
                console.log('‚úÖ Message displayed');
            } catch (e) {
                console.error('‚ùå Error in displayMessage:', e);
            }
        }

        async function loadMessages() {
            try {
                console.log('üì® Loading messages...');
                const res = await fetch('/messages?take=200');
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `HTTP error ${res.status}`);
                }
                const data = await res.json();
                console.log(`‚úÖ Loaded ${data.length} messages`);
                if (!Array.isArray(data)) {
                    throw new Error('Data is not array');
                }
                messagesEl.innerHTML = '';
                data.forEach(displayMessage);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (e) {
                setStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
                console.error('‚ùå loadMessages error:', e);
            }
        }

        async function createOrGetUser() {
            const email = emailInput.value.trim();
            if (!email) {
                setStatus('error', '–í–≤–µ–¥–∏—Ç–µ email');
                return;
            }
            try {
                console.log('üì® Creating/getting user with email:', email);
                const res = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, name: nameInput.value.trim() || undefined })
                });
                const user = await res.json();
                if (!res.ok) throw new Error(user.error || '–û—à–∏–±–∫–∞');
                currentUserId = user.id;
                localStorage.setItem('userId', currentUserId);
                setStatus('ok', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.name || user.email} (ID —Å–æ—Ö—Ä–∞–Ω—ë–Ω)`);
                emailInput.disabled = true;
                nameInput.disabled = true;
                createUserBtn.disabled = true;
                console.log('‚úÖ User set:', user);
            } catch (e) {
                setStatus('error', e.message);
                console.error('‚ùå createOrGetUser error:', e);
            }
        }

        async function sendMessage() {
            if (!currentUserId) {
                setStatus('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            const text = textInput.value.trim();
            if (!text) return;
            try {
                console.log('üì® Sending message:', { text, senderId: currentUserId });
                const res = await fetch('/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, senderId: currentUserId })
                });
                const data = await res.json();
                console.log('üì® POST /messages response:', data);
                if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞');
                textInput.value = '';
                // —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
            } catch (e) {
                setStatus('error', e.message);
                console.error('‚ùå sendMessage error:', e);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
        socket.on('new_message', (msg) => {
            console.log('üì© New message received via socket:', msg);
            displayMessage(msg);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        });

        // –ï—Å–ª–∏ userId —É–∂–µ –µ—Å—Ç—å –≤ localStorage
        if (currentUserId) {
            emailInput.disabled = true;
            nameInput.disabled = true;
            createUserBtn.disabled = true;
            setStatus('ok', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! ID –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage');
            console.log('üîÑ Existing userId:', currentUserId);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        createUserBtn.addEventListener('click', createOrGetUser);
        sendBtn.addEventListener('click', sendMessage);
        reloadBtn.addEventListener('click', loadMessages);
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadMessages();
    </script>
</body>
</html>